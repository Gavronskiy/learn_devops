name: CI – Test Flask CRUD in Docker with MySQL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-app:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: mydb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: docker build -t flask-crud-app .

    - name: Run app container in background
      run: |
        docker run -d \
          --name flask-crud-test \
          -e MYSQL_HOST=mysql \
          -e MYSQL_USER=root \
          -e MYSQL_PASSWORD=rootpass \
          -e MYSQL_DB=mydb \
          -p 3000:3000 \
          --network host \
          flask-crud-app

    - name: Wait for app to become ready
      run: |
        echo "Waiting for app to be ready..."
        for i in {1..10}; do
          if curl -s http://localhost:3000 >/dev/null; then
            echo "✅ App is up!"
            exit 0
          else
            echo "Waiting... ($i)"
            sleep 5
          fi
        done
        echo "❌ App did not start in time"
        docker logs flask-crud-test
        exit 1

    - name: Clean up containers
      if: always()
      run: |
        docker stop flask-crud-test || true
        docker rm flask-crud-test || true

